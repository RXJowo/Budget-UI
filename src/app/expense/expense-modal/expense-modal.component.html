<ion-header [translucent]="false">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button 
        fill="clear" 
        color="medium"
        [disabled]="loading"
        (click)="cancel()">
        <ion-icon name="close-outline" slot="start" />
        CANCEL
      </ion-button>
    </ion-buttons>

    <ion-title>{{ expense?.id ? 'Edit' : 'Add' }} Expense</ion-title>

    <ion-buttons slot="end">
      <ion-button 
        fill="clear" 
        color="medium"
        [disabled]="expenseForm.invalid || loading" 
        (click)="save()">
        @if (loading) {
          <ion-spinner name="crescent" />
        } @else {
          <ion-icon name="save-outline" slot="start" />
          SAVE
        }
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" [formGroup]="expenseForm">
  <ion-list lines="full" class="expense-form">

    <!-- Name -->
    <ion-item class="form-item">
      <ion-icon name="text-outline" slot="start" class="item-icon" />
      <ion-input
        #nameInput
        formControlName="name"
        class="item-input"
        placeholder="Name"
        [clearInput]="true" />
    </ion-item>
    
    <!-- Name Validation Errors -->
    @if (expenseForm.get('name')?.touched && expenseForm.get('name')?.invalid) {
      <div class="error-message">
        @if (expenseForm.get('name')?.hasError('required')) {
          Name is required
        }
        @if (expenseForm.get('name')?.hasError('maxlength')) {
          Name must be less than 40 characters
        }
      </div>
    }

    <!-- Category -->
    <ion-item class="form-item">
      <ion-icon name="pricetag-outline" slot="start" class="item-icon" />
      <ion-select
        interface="popover"
        placeholder="Category (optional)"
        [value]="expenseForm.get('categoryId')?.value"
        (ionChange)="onCategoryChange($event.detail.value)">
        <ion-select-option [value]="null">No category</ion-select-option>
        @for (category of categories; track category.id) {
          <ion-select-option [value]="category.id">
            {{ category.name }}
          </ion-select-option>
        }
      </ion-select>
      <ion-button 
        fill="solid" 
        slot="end" 
        class="add-button" 
        [disabled]="loading"
        (click)="createNewCategory()">
        <ion-icon name="add-outline" slot="icon-only" />
      </ion-button>
    </ion-item>

    <!-- Amount -->
    <ion-item class="form-item">
      <ion-icon name="cash-outline" slot="start" class="item-icon" />
      <ion-input
        formControlName="amount"
        class="item-input"
        type="number"
        inputmode="decimal"
        placeholder="Amount"
        [clearInput]="true" />
      <ion-label slot="end" class="currency-label">CHF</ion-label>
    </ion-item>
    
    <!-- Amount Validation Errors -->
    @if (expenseForm.get('amount')?.touched && expenseForm.get('amount')?.invalid) {
      <div class="error-message">
        @if (expenseForm.get('amount')?.hasError('required')) {
          Amount is required
        }
        @if (expenseForm.get('amount')?.hasError('min')) {
          Amount must be greater than 0
        }
      </div>
    }

    <!-- Date -->
    <ion-item class="form-item">
      <ion-icon name="calendar-outline" slot="start" class="item-icon" />
      <ion-datetime-button datetime="expense-date" class="date-button" />
    </ion-item>

  </ion-list>

  <!-- Date picker -->
  <ion-modal [keepContentsMounted]="true">
    <ng-template>
      <ion-datetime
        id="expense-date"
        presentation="date"
        formControlName="date"
        [showDefaultButtons]="true" />
    </ng-template>
  </ion-modal>
</ion-content>

<!-- Footer with Delete Button (only when editing) -->
@if (expense?.id) {
  <ion-footer>
    <ion-toolbar>
      <ion-button 
        expand="block" 
        color="danger" 
        [disabled]="loading"
        (click)="deleteExpense()">
        <ion-icon name="trash-outline" slot="start" />
        DELETE EXPENSE
      </ion-button>
    </ion-toolbar>
  </ion-footer>
}

<style>
  /* Header */
  ion-header ion-toolbar {
    padding: 4px 0;
  }

  ion-header ion-title {
    font-size: 17px;
    font-weight: 500;
    text-align: center;
  }

  ion-header ion-button {
    font-size: 13px;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    --border-radius: 0;
    --ripple-color: transparent;
  }

  ion-header ion-button::part(native) {
    border-radius: 0;
  }

  ion-header ion-button ion-icon {
    font-size: 18px;
    margin-right: 6px;
  }

  ion-header ion-spinner {
    width: 18px;
    height: 18px;
    margin-right: 6px;
  }

  /* List layout */
  .expense-form {
    padding: 0;
    background: transparent;
    margin-top: 0;
  }

  .form-item {
    --inner-padding-start: 16px;
    --inner-padding-end: 16px;
    --padding-start: 16px;
    --padding-end: 16px;
    --min-height: 52px;
    margin: 0;
  }

  .item-icon {
    font-size: 22px;
    margin-right: 16px;
  }

  .item-input {
    --padding-start: 0;
    --padding-end: 0;
    --padding-top: 0;
    --padding-bottom: 0;
    font-size: 16px;
  }

  ion-input::part(native) {
    padding: 0 !important;
  }

  /* Select */
  ion-select {
    width: 100%;
    max-width: 100%;
    padding: 0;
  }

  /* Add button for category */
  .add-button {
    --border-radius: 6px;
    --padding-start: 0;
    --padding-end: 0;
    width: 32px;
    height: 32px;
    margin-left: 8px;
  }

  .add-button ion-icon {
    font-size: 18px;
  }

  /* Currency label */
  .currency-label {
    font-size: 16px;
    margin: 0;
  }

  /* Validation Error Messages */
  .error-message {
    color: var(--ion-color-danger);
    padding: 8px 16px;
    font-size: 14px;
    margin-left: 38px; /* Align with input field after icon */
  }

  /* Date button */
  .date-button {
    margin: 0;
    padding: 0;
  }

  ion-datetime-button::part(native) {
    border-radius: 6px;
    padding: 6px 14px;
    font-size: 15px;
    font-weight: 400;
  }

  /* Footer */
  ion-footer ion-toolbar {
    --border-color: transparent;
    --min-height: 64px;
    padding: 8px 16px;
  }

  ion-footer ion-button {
    margin: 0;
    height: 48px;
    font-size: 14px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  ion-footer ion-button ion-icon {
    font-size: 20px;
    margin-right: 8px;
  }

  @media (min-width: 768px) {
    .expense-form {
      max-width: 600px;
      margin: 0 auto;
    }
  }
</style>