<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button color="medium" (click)="cancel()">
        <ion-icon slot="start" name="close" />
        Cancel
      </ion-button>
    </ion-buttons>

    <ion-title>{{ expense.id ? 'Edit' : 'Add' }} expense</ion-title>

    <ion-buttons slot="end">
      <ion-button 
        [disabled]="expenseForm.pristine || expenseForm.invalid || isSaving" 
        (click)="save()">
        <ion-icon slot="start" name="save" />
        {{ isSaving ? 'Saving...' : 'Save' }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <form [formGroup]="expenseForm">
    <!-- Title -->
    <ion-item>
      <ion-icon slot="start" name="text-outline"></ion-icon>
      <ion-input
        formControlName="name"
        label="Title"
        labelPlacement="floating"
        placeholder="Expense title"
        maxlength="100"
        [clearInput]="true"
        required="true">
      </ion-input>
    </ion-item>

    <!-- Validation Error for Title -->
    <div *ngIf="expenseForm.get('name')?.touched && expenseForm.get('name')?.invalid" 
         class="error-message">
      <div *ngIf="expenseForm.get('name')?.hasError('required')">
        Title is required
      </div>
      <div *ngIf="expenseForm.get('name')?.hasError('maxlength')">
        Title must be less than 100 characters
      </div>
    </div>

    <!-- Category -->
    <ion-item>
      <ion-icon slot="start" name="pricetag-outline"></ion-icon>
      <ion-select
        formControlName="categoryId"
        label="Category"
        labelPlacement="floating"
        interface="popover"
        placeholder="Select category">
        <ion-select-option value="">No category</ion-select-option>
        <ion-select-option *ngFor="let category of availableCategories" [value]="category.id">
          {{ category.name }}
        </ion-select-option>
      </ion-select>
    </ion-item>

    <!-- Amount -->
    <ion-item>
      <ion-icon slot="start" name="cash-outline"></ion-icon>
      <ion-input
        type="number"
        inputmode="decimal"
        step="0.05"
        min="0.01"
        formControlName="amount"
        label="Amount (CHF)"
        labelPlacement="floating"
        placeholder="0.00"
        required="true">
      </ion-input>
    </ion-item>

    <!-- Validation Error for Amount -->
    <div *ngIf="expenseForm.get('amount')?.touched && expenseForm.get('amount')?.invalid" 
         class="error-message">
      <div *ngIf="expenseForm.get('amount')?.hasError('required')">
        Amount is required
      </div>
      <div *ngIf="expenseForm.get('amount')?.hasError('min')">
        Amount must be at least 0.01 CHF
      </div>
    </div>

    <!-- Date -->
    <ion-item>
      <ion-icon slot="start" name="calendar-outline"></ion-icon>
      <ion-datetime
        presentation="date"
        formControlName="date"
        label="Date"
        labelPlacement="floating"
        [max]="maxDate"
        [showDefaultButtons]="true">
      </ion-datetime>
    </ion-item>

    <!-- Delete Button - nur im Edit-Modus -->
    <div *ngIf="expense.id" class="delete-section">
      <ion-button 
        expand="block" 
        fill="outline" 
        color="danger"
        (click)="delete()"
        [disabled]="isSaving">
        <ion-icon slot="start" name="trash-outline"></ion-icon>
        Delete Expense
      </ion-button>
    </div>
  </form>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-content">
    <ion-spinner name="circular"></ion-spinner>
    <p>Loading categories...</p>
  </div>

  <!-- Form Summary Card -->
  <ion-card class="summary-card" *ngIf="expenseForm.valid && !isLoading">
    <ion-card-header>
      <ion-card-title>Summary</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="summary-grid">
        <div class="summary-item">
          <span class="label">Title:</span>
          <span class="value">{{ expenseForm.get('name')?.value || 'Untitled' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Amount:</span>
          <span class="value amount-highlight">{{ expenseForm.get('amount')?.value | currency:'CHF':'symbol':'1.2-2' }}</span>
        </div>
        <div class="summary-item" *ngIf="expenseForm.get('categoryId')?.value">
          <span class="label">Category:</span>
          <span class="value">{{ getCategoryName(expenseForm.get('categoryId')?.value || '') }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Date:</span>
          <span class="value">{{ expenseForm.get('date')?.value | date:'mediumDate' }}</span>
        </div>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>